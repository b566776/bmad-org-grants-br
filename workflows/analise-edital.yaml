version: "1.0"
name: "analise-edital"
description: >
  Workflow para analisar edital, gerar resumo t√©cnico, checklist de requisitos
  e sugest√µes iniciais de linhas de projeto para a Organiza√ß√£o.
  Inclui micro-checkpoints de resili√™ncia:
  - Filtro de inelegibilidade (red flags / desclassifica√ß√£o imediata)
  - An√°lise de ‚Äúsentimento‚Äù do edital (palavras-chave e sem√¢ntica valorizada)

inputs:
  arquivo_pdf_edital:
    description: "Caminho do arquivo PDF do edital (local ou j√° processado)."
    required: false
  arquivo_memoria_edital:
    description: "Arquivo de mem√≥ria do edital em .bmad-custom/memories/editais/<nome>.md."
    required: true
  url_formulario_opcional:
    description: "URL do formul√°rio de submiss√£o online (opcional, para extra√ß√£o de perguntas)."
    required: false

tasks:
  - id: validar-estrutura
    description: >
      Validar e preparar estrutura de mem√≥rias antes de processar edital.
      
      0. DETECTAR PERFIL ATIVO (Multi-Organiza√ß√µes):
         - Verificar se existe organizations/.current
         - Se SIM:
           a) Ler perfil ativo de .current
           b) Usar organizations/{perfil-ativo}/ como base
           c) Avisar: "üè¢ Organiza√ß√£o ativa: {nome} ({perfil})"
         - Se N√ÉO:
           a) Usar memories/ (compatibilidade legado)
           b) Avisar: "‚ö†Ô∏è  Usando estrutura legado. Considere migrar para multi-org."
      
      1. VALIDAR DIRET√ìRIOS (criar se ausentes no perfil ativo):
         - {perfil}/certidoes/
         - {perfil}/documentos_bancarios/
         - {perfil}/documentos_institucionais/
         - {perfil}/projetos_anteriores/
         - {perfil}/logs/
      
      2. VALIDAR ARQUIVOS OBRIGAT√ìRIOS:
         - {perfil}/HISTORICO_EDITAIS.md (criar template se ausente)
      
      3. AN√ÅLISE INTELIGENTE DE ORGANIZATION_PORTFOLIO.md:
         - Se AUSENTE ou VAZIO:
           a) Escanear TODO o conte√∫do de {perfil}/ (todas as subpastas)
           b) Ler arquivos .md existentes (projetos anteriores, etc.)
           c) Extrair metadados de PDFs (CNPJs, certid√µes, etc.) se poss√≠vel
           d) GERAR automaticamente {perfil}/ORGANIZATION_PORTFOLIO.md consolidando:
              * Dados institucionais encontrados
              * Hist√≥rico de projetos anteriores
              * Capacidades identificadas
              * Certifica√ß√µes encontradas
           e) Avisar usu√°rio que portfolio foi gerado automaticamente
         
         - Se EXISTENTE e PREENCHIDO:
           a) Validar se est√° atualizado (comparar com conte√∫do de {perfil}/)
           b) Sugerir atualiza√ß√£o se arquivos s√£o mais recentes
      
      4. CARREGAR METADADOS DA ORGANIZA√á√ÉO:
         - Ler {perfil}/config.json se existir
         - Extrair: nome, tipo, CNPJ, √°reas de atua√ß√£o
         - Disponibilizar para uso nas fases seguintes
      
      5. RESULTADO:
         - Relat√≥rio de valida√ß√£o (arquivos criados, avisos, etc.)
         - Confirma√ß√£o de que estrutura est√° pronta
         - Lista de informa√ß√µes encontradas/faltantes
         - Metadados da organiza√ß√£o ativa
    
    output:
      estrutura_valida: boolean
      portfolio_gerado: boolean
      avisos: list
      perfil_ativo: string  # Nome do perfil (ex: "default", "ong-xyz")
      organizacao: dict     # Dados do config.json
      resumo_organizacao: dict  # Informa√ß√µes consolidadas para uso nas fases

  - id: carregar-contexto
    description: "Carregar conte√∫do do edital e mem√≥ria associada."
    input:
      pdf: "{{ inputs.arquivo_pdf_edital }}"
      memoria: "{{ inputs.arquivo_memoria_edital }}"
      dados_organizacao: "{{ tasks.validar-estrutura.output.resumo_organizacao }}"

  - id: gerar-resumo
    description: "Gerar resumo t√©cnico do edital."
    input:
      memoria: "{{ tasks.carregar-contexto.output }}"

  - id: gerar-checklist
    description: "Gerar checklist de requisitos e documentos obrigat√≥rios."
    input:
      resumo: "{{ tasks.gerar-resumo.output }}"

  - id: filtro-inelegibilidade
    description: >
      Micro-checkpoint: detectar ‚Äúred flags‚Äù de inelegibilidade que desqualificariam a Organiza√ß√£o imediatamente.
      Produza um parecer GO/NO-GO com evid√™ncias e itens faltantes para confirmar elegibilidade.
    input:
      contexto: "{{ tasks.carregar-contexto.output }}"
      resumo: "{{ tasks.gerar-resumo.output }}"
      checklist: "{{ tasks.gerar-checklist.output }}"

  - id: analise-sentimento-edital
    description: >
      Micro-checkpoint: identificar a sem√¢ntica valorizada pelo edital (palavras/express√µes recorrentes),
      sugerindo como replicar a linguagem na Fase 3 sem ‚Äúencher lingui√ßa‚Äù.
    input:
      contexto: "{{ tasks.carregar-contexto.output }}"
      resumo: "{{ tasks.gerar-resumo.output }}"
      checklist: "{{ tasks.gerar-checklist.output }}"

  - id: capturar-questionario-submissao
    description: >
      Capturar perguntas do formul√°rio de submiss√£o (manual ou via browser com comando EXTRAIR QUESTIONARIO).
      Identificar cada pergunta, limite de caracteres, tipo de resposta esperada.
      Esta captura antecipada permite planejar estrategicamente as respostas nas Fases 2-4.
    input:
      edital: "{{ tasks.carregar-contexto.output }}"
      url_formulario: "{{ inputs.url_formulario_opcional }}"

outputs:
  resumo_tecnico:
    description: "Resumo t√©cnico estruturado do edital."
  checklist_requisitos:
    description: "Checklist de requisitos e documentos obrigat√≥rios."
  inelegibilidade_red_flags:
    description: >
      Parecer GO/NO-GO (evid√™ncias) + lista de red flags: tempo m√≠nimo de funda√ß√£o, territ√≥rio/UF, CNPJ/registro,
      certid√µes/regularidade, p√∫blico-alvo restrito, natureza jur√≠dica, contrapartidas impeditivas etc.
  palavras_chave_valorizadas:
    description: >
      Palavras/express√µes com alta √™nfase no edital (ex.: inova√ß√£o, escala, sustentabilidade, equidade),
      com recomenda√ß√£o de uso na Fase 3 (frases-modelo e pontos onde inserir).
  questionario_formulario:
    description: >
      Lista de perguntas do formul√°rio de submiss√£o com limites de caracteres identificados.
      Permite planejamento estrat√©gico das respostas desde a Fase 2.

